#!/bin/bash
set -euo pipefail

BASE_IPA="$1"
P12_FILE="$2"
P12_PASSWORD="$3"
PROFILE="$4"
OUTPUT_IPA="$5"

WORK_DIR="$(mktemp -d)"
KEYCHAIN="$WORK_DIR/temp-signing.keychain-db"
KC_PASSWORD="temp123"

echo "Working directory: $WORK_DIR"

############################################################
# Create + unlock a temporary keychain (must use real pass)
############################################################

echo "Creating temporary keychain..."
security create-keychain -p "$KC_PASSWORD" "$KEYCHAIN"
security set-keychain-settings -lut 7200 "$KEYCHAIN"
security unlock-keychain -p "$KC_PASSWORD" "$KEYCHAIN"

# Activate this keychain *exclusively* for this script
security list-keychain -d user -s "$KEYCHAIN"

############################################################
# Import the .p12 certificate into the keychain
############################################################

echo "Importing certificate: $P12_FILE"

security import "$P12_FILE" \
    -k "$KEYCHAIN" \
    -P "$P12_PASSWORD" \
    -A \
    -T /usr/bin/codesign \
    -T /usr/bin/security

############################################################
# Extract IPA
############################################################

mkdir -p "$WORK_DIR/ipa"
unzip -q "$BASE_IPA" -d "$WORK_DIR/ipa"

APP_PATH="$(find "$WORK_DIR/ipa/Payload" -maxdepth 1 -name "*.app" | head -n 1)"
if [[ -z "$APP_PATH" ]]; then
    echo "Error: No .app bundle found inside IPA."
    exit 1
fi

############################################################
# Insert provisioning profile
############################################################

if [[ ! -f "$PROFILE" ]]; then
    echo "Error: Provisioning profile not found: $PROFILE"
    exit 1
fi

echo "Embedding provisioning profile: $PROFILE"
cp "$PROFILE" "$APP_PATH/embedded.mobileprovision"

############################################################
# Extract entitlements (optional)
############################################################

ENTITLEMENTS="$WORK_DIR/entitlements.plist"
if codesign -d --entitlements :- "$APP_PATH" > "$ENTITLEMENTS" 2>/dev/null; then
    echo "Extracted entitlements."
else
    echo "Warning: Could not extract entitlements. Signing without explicit entitlements."
    rm -f "$ENTITLEMENTS"
fi

############################################################
# Remove old signature
############################################################

rm -rf "$APP_PATH/_CodeSignature"

############################################################
# Determine signing identity
############################################################

IDENTITY=$(security find-identity -p codesigning -v "$KEYCHAIN" | head -n 1 | awk -F'"' '{print $2}')

if [[ -z "${IDENTITY:-}" ]]; then
    echo "Error: No signing identity found in imported certificate."
    exit 1
fi

echo "Using signing identity: $IDENTITY"

############################################################
# Perform the signing
############################################################

if [[ -f "$ENTITLEMENTS" ]]; then
    codesign -f -s "$IDENTITY" --entitlements "$ENTITLEMENTS" --deep "$APP_PATH"
else
    codesign -f -s "$IDENTITY" --deep "$APP_PATH"
fi

############################################################
# Repackage IPA
############################################################

pushd "$WORK_DIR/ipa" >/dev/null
zip -qry "$WORK_DIR/signed.ipa" Payload
popd >/dev/null

mkdir -p "$(dirname "$OUTPUT_IPA")"
mv "$WORK_DIR/signed.ipa" "$OUTPUT_IPA"

############################################################
# Cleanup
############################################################

security delete-keychain "$KEYCHAIN" || true
rm -rf "$WORK_DIR"

echo "Signed IPA written to: $OUTPUT_IPA"
