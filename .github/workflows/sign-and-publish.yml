name: Sign IPAs and publish OTA

on:
  workflow_dispatch:
  schedule:
    - cron: "0 12 * * *"  # every day at 12:00 UTC

permissions:
  contents: write

jobs:
  sign-and-publish:
    runs-on: macos-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare folders
        run: |
          mkdir -p Feather/output

      - name: Download base IPA
        run: |
          curl -L "https://files.catbox.moe/15nd3m.ipa" -o base.ipa

      - name: Download certificates zip
        run: |
          curl -L "https://raw.githubusercontent.com/WhySooooFurious/Ultimate-Sideloading-Guide/refs/heads/main/raw-files/certificates.zip" -o certificates.zip
          mkdir certs
          unzip -q certificates.zip -d certs

      - name: Sign missing IPAs and generate plists
        run: |
          chmod +x scripts/resign_ipa.sh
          chmod +x scripts/generate_plist.sh

          for p12 in $(find certs -name "*.p12"); do
            basename="$(basename "$p12" .p12)"
            IPA_OUT="Feather/output/${basename}.ipa"
            PLIST_OUT="Feather/output/${basename}.plist"

            if [ -f "$IPA_OUT" ] && [ -f "$PLIST_OUT" ]; then
              echo "Already have $IPA_OUT and $PLIST_OUT, skipping"
              continue
            fi

            echo "Signing base IPA with cert $basename..."
            ./scripts/resign_ipa.sh base.ipa "$p12" "WSF" "$IPA_OUT"

            echo "Generating plist for $IPA_OUT..."
            ./scripts/generate_plist.sh "$IPA_OUT" "$PLIST_OUT"
          done

      - name: Regenerate index.html
        run: |
          chmod +x generate_index.sh
          ./generate_index.sh

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add Feather/output/*.ipa Feather/output/*.plist index.html 2>/dev/null || true

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Auto-sign IPAs and update OTA index"
          git push
