#!/bin/bash
set -euo pipefail

# =========================================
# CONFIGURATION
# =========================================

ZIP_URL="https://raw.githubusercontent.com/WhySooooFurious/Ultimate-Sideloading-Guide/refs/heads/main/raw-files/certificates.zip"
IPA_URL="https://github.com/FrizzleM/BreakFree/raw/refs/heads/main/Feather/featherunsigned.ipa"
OUT_DIR="/workspaces/BreakFree/Feather/output"
WORK_DIR="$(mktemp -d)"
ZIP_PATH="$WORK_DIR/certificates.zip"
CERT_DIR="$WORK_DIR/certificates"
P12_PASSWORD="WSF"

# Create output folder if it doesn't exist
mkdir -p "$OUT_DIR"

echo "ðŸ”½ Downloading certificates.zip..."
curl -L -o "$ZIP_PATH" "$ZIP_URL"

echo "ðŸ“¦ Extracting certificates..."
unzip -q "$ZIP_PATH" -d "$WORK_DIR"

# Locate the real certificates folder (nested under /certificates)
if [[ -d "$WORK_DIR/certificates/certificates" ]]; then
    CERT_DIR="$WORK_DIR/certificates/certificates"
fi

echo "ðŸ“¥ Downloading unsigned IPA..."
IPA_PATH="$WORK_DIR/featherunsigned.ipa"
curl -L -o "$IPA_PATH" "$IPA_URL"

echo "âœ… Starting signing loop..."

for folder in "$CERT_DIR"/*; do
    # Skip anything that's not a folder
    [[ -d "$folder" ]] || continue

    NAME=$(basename "$folder")
    P12_FILE="$folder/$NAME.p12"
    PROFILE_FILE="$folder/$NAME.mobileprovision"

    if [[ ! -f "$P12_FILE" || ! -f "$PROFILE_FILE" ]]; then
        echo "âš ï¸ Skipping $NAME â€” missing files"
        continue
    fi

    OUTPUT_IPA="$OUT_DIR/${NAME}-signed.ipa"

    echo "--------------------------------------"
    echo "ðŸ” Signing with certificate: $NAME"
    echo "--------------------------------------"

    # Temporary keychain for each certificate
    KEYCHAIN="$WORK_DIR/${NAME}_temp.keychain-db"
    KC_PASS="temp123"

    # Create and use the temporary keychain
    security create-keychain -p "$KC_PASS" "$KEYCHAIN"
    security set-keychain-settings -lut 7200 "$KEYCHAIN"
    security unlock-keychain -p "$KC_PASS" "$KEYCHAIN"
    security list-keychain -d user -s "$KEYCHAIN"

    # Import certificate
    security import "$P12_FILE" -k "$KEYCHAIN" -P "$P12_PASSWORD" -A \
        -T /usr/bin/codesign -T /usr/bin/security

    # Extract and prepare IPA
    APP_DIR="$WORK_DIR/${NAME}_ipa"
    mkdir -p "$APP_DIR"
    unzip -q "$IPA_PATH" -d "$APP_DIR"

    APP_PATH="$(find "$APP_DIR/Payload" -maxdepth 1 -name '*.app' | head -n 1)"
    cp "$PROFILE_FILE" "$APP_PATH/embedded.mobileprovision"

    # Remove old signature
    rm -rf "$APP_PATH/_CodeSignature"

    # Determine signing identity
    IDENTITY=$(security find-identity -p codesigning -v "$KEYCHAIN" | head -n 1 | awk -F'"' '{print $2}')
    if [[ -z "$IDENTITY" ]]; then
        echo "âŒ No signing identity found for $NAME"
        security delete-keychain "$KEYCHAIN"
        rm -rf "$APP_DIR"
        continue
    fi

    echo "Using identity: $IDENTITY"

    # Sign app
    codesign -f -s "$IDENTITY" --deep "$APP_PATH"

    # Repackage IPA
    pushd "$APP_DIR" >/dev/null
    zip -qry "$OUTPUT_IPA" Payload
    popd >/dev/null

    echo "âœ… Signed IPA saved to: $OUTPUT_IPA"

    # Clean up temp keychain and folder
    security delete-keychain "$KEYCHAIN" || true
    rm -rf "$APP_DIR"
done

echo "ðŸŽ‰ All signing operations complete!"
echo "Signed IPAs are in: $OUT_DIR"

# Clean up global temp
rm -rf "$WORK_DIR"